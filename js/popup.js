let highest_z_index=1,cached_popups=new Map;function getPopup(o){if(!cached_popups.has(o)){var t=window.POPUP_DATA[o],n=t.associated_url?`<div class="popupHeaderButton popupHeaderButtonHref"><a href="${t.associated_url}">»</a></div>`:"",s=document.createElement("template");s.innerHTML=`<div class="popup" data-injection-arg="${o}">
                <div class="popupHeader">
                    <div class="popupHeaderButtongroup" onmousedown="event.stopPropagation()">
                        ${n}
                        <div class="popupHeaderButton popupHeaderButtonSave">☆</div>
                        <div class="popupHeaderButton popupHeaderButtonSticky">○</div>
                        <div class="popupHeaderButton popupHeaderButtonClose">×</div>
                    </div>
                    ${t.title}
                </div>
                <div class="popupContent">
                    ${t.content_html}
                </div>
            </div>`;let e=s.content.firstChild;if(null===e)throw Error("template didn't work: "+s);if(!(e instanceof HTMLElement))throw Error("popup isn't an HTMLElement: "+e);e.onclick=t=>sendToTop(e),setPosition(e,"absolute",!1),getButton(e,"popupHeaderButtonSave").onclick=t=>toggleIsSaved(e,t),getButton(e,"popupHeaderButtonSticky").onclick=t=>toggleIsPinned(e,t),getButton(e,"popupHeaderButtonClose").onclick=t=>closePopup(e),getPopupContent(e).firstElementChild.onscroll=t=>mutateStyleDatum(o,t=>t.scroll=getPopupScroll(e)),document.getElementsByTagName("article")[0].append(e),cached_popups.set(o,e)}return cached_popups.get(o)}function getPopupHeader(t){return t.children[0]}function getPopupContent(t){return t.children[1]}function getPopupScroll(t){return getPopupContent(t).firstElementChild.scrollTop}function setPopupScroll(t,e){getPopupContent(t).firstElementChild.scrollTop=e}function getInjectionArg(t){return t.dataset.injectionArg}function getPageHeader(){return document.getElementsByTagName("header")[0]}function getClientRect(t){t=t.getBoundingClientRect();return{top:t.top,right:t.right,bottom:t.bottom,left:t.left}}function getPageRect(t){t=t.getBoundingClientRect();return{top:t.top+window.scrollY,right:t.right+window.scrollX,bottom:t.bottom+window.scrollY,left:t.left+window.scrollX}}function setCoords(e,t){e.style.top=t.top+"px",void 0!==t.left?(e.style.left=t.left+"px",e.style.removeProperty("right")):(e.style.right=t.right+"px",e.style.removeProperty("left")),mutateStyleDatum(getInjectionArg(e),t=>{t.left=e.style.left,t.right=e.style.right,t.top=e.style.top});var o,t=document.getElementsByTagName("body")[0],n=getClientRect(e).bottom-getClientRect(t).bottom;0<n&&(o=Number(t.style.paddingBottom.slice(0,-2)),t.style.paddingBottom=o+n+"px")}function getStyleDatum(t){return{left:t.style.left,right:t.style.right,top:t.style.top,isCollapsed:getIsCollapsed(t),scroll:getPopupScroll(t),zIndex:t.style.zIndex,isPinned:getIsPinned(t),isSaved:getIsSaved(t)}}class StoredDataManager{constructor(t,e){this.storage=t,this.data_key=e}getData(){var t;return JSON.parse(null!=(t=this.storage.getItem(this.data_key))?t:"{}")}setData(t){this.storage.setItem(this.data_key,JSON.stringify(t))}hasDatum(t){return t in this.getData()}mutateData(t){var e=this.getData();t(e),this.setData(e)}mutateDatum(e,o){this.mutateData(t=>{e in t&&o(t[e])})}}let PINNED_POPUP_DATA=new StoredDataManager(sessionStorage,"pinnedPopupData"),SAVED_POPUP_DATA=new StoredDataManager(localStorage,"savedPopupData");function restorePopup(e,o){var t=getPopup(e);setIsDraggable(t,!0),setIsVisible(t,!0),t.style.top=o.top,t.style.right=o.right,t.style.left=o.left,t.style.zIndex=o.zIndex,maybeUpdateHighestZIndex(o.zIndex),setPopupScroll(t,o.scroll),setIsCollapsed(t,o.isCollapsed),setIsPinned(t,o.isPinned,!1),setIsSaved(t,o.isSaved),o.isPinned&&PINNED_POPUP_DATA.mutateData(t=>t[e]=o),o.isSaved&&SAVED_POPUP_DATA.mutateData(t=>t[e]=o)}function restoreSavedPopups(){Object.entries(SAVED_POPUP_DATA.getData()).forEach(([t,e])=>restorePopup(t,e))}function getIsPinned(t){return PINNED_POPUP_DATA.hasDatum(getInjectionArg(t))}function setIsPinned(t,e,o=!0){setPosition(t,e?"fixed":"absolute",o),setPinButton(t,e);let n=getInjectionArg(t);if(e){let e=getStyleDatum(t);e.isPinned=!0,PINNED_POPUP_DATA.mutateData(t=>t[n]=e)}else PINNED_POPUP_DATA.mutateData(t=>delete t[n]);SAVED_POPUP_DATA.mutateDatum(n,t=>t.isPinned=e)}function toggleIsPinned(t,e){e.stopPropagation(),setIsPinned(t,!getIsPinned(t))}function getIsSaved(t){return SAVED_POPUP_DATA.hasDatum(getInjectionArg(t))}function setIsSaved(t,e){setSaveButton(t,e);let o=getInjectionArg(t);if(e){let e=getStyleDatum(t);e.isSaved=!0,SAVED_POPUP_DATA.mutateData(t=>t[o]=e)}else SAVED_POPUP_DATA.mutateData(t=>delete t[o]);PINNED_POPUP_DATA.mutateDatum(o,t=>t.isSaved=e)}function toggleIsSaved(t,e){e.stopPropagation(),setIsSaved(t,!getIsSaved(t))}function mutateStyleDatum(t,e){PINNED_POPUP_DATA.mutateDatum(t,e),SAVED_POPUP_DATA.mutateDatum(t,e)}function setPosition(t,e,o=!0){var n;e!==t.style.position&&(n=("fixed"===e?getClientRect:getPageRect)(t),t.style.position=e,o)&&(t.style.right?setCoords(t,{top:n.top,right:getClientRect(document.documentElement).right-n.right,left:void 0}):setCoords(t,{top:n.top,left:n.left,right:void 0}))}function sendToTop(e){var t;e.style.zIndex!==String(highest_z_index)&&(t=highest_z_index+1,e.style.zIndex=String(t),maybeUpdateHighestZIndex(t),mutateStyleDatum(getInjectionArg(e),t=>t.zIndex=e.style.zIndex))}function maybeUpdateHighestZIndex(t){(t=Number(t))>highest_z_index&&(highest_z_index=t,getPageHeader().style.zIndex=String(highest_z_index+1))}function getAdjustedY(t,e){return t<e?e:t}function getIsCollapsed(t){return t.classList.contains("isCollapsed")}function setIsCollapsed(t,e){e?t.classList.add("isCollapsed"):t.classList.remove("isCollapsed"),mutateStyleDatum(getInjectionArg(t),t=>t.isCollapsed=e)}function sendToAnchor(t,e){if(!e.classList.contains("popupAnchor"))throw Error("Element isn't a popup anchor: "+e.getHTML());var o=getPageRect(e),n=t.getBoundingClientRect().height,s=window.innerHeight,i=o.top-n,a=getPageRect(getPageHeader()).bottom;getClientRect(e).bottom+n>s&&a<i?setCoords(t,{left:o.left,top:i,right:void 0}):setCoords(t,{left:o.left,top:o.bottom,right:void 0})}function getIsDraggable(t){return t.classList.contains("isDraggable")}function setIsDraggable(u,t){if(getIsDraggable(u)!==t){var e=getPopupHeader(u);if(t){let s,i,a,l=-1,r=-1,p=!1;sendToTop(u),e.onmousedown=t=>{s=getClientRect(getPageHeader()).bottom+t.clientY-getClientRect(u).top,i=t.clientX,a=getAdjustedY(t.clientY,s),document.onmousemove=t=>{var e=t.clientX-i,o=getAdjustedY(t.clientY,s)-a,t=(i=t.clientX,a=getAdjustedY(t.clientY,s),getClientRect(u)),n=u.offsetTop+o;t.left+e<=0||0<r&&l+e<r?(l<0&&(l=r=t.right),l+=e,t=getClientRect(document.documentElement).right-l,setCoords(u,{top:n,right:t,left:void 0})):(t=u.offsetLeft+e,setCoords(u,{top:n,left:t,right:void 0}),l=r=-1),p=p||0!=e||0!=o},document.onmouseup=t=>{document.onmouseup=null,document.onmousemove=null,p||setIsCollapsed(u,!getIsCollapsed(u)),p=!1},sendToTop(u)},u.classList.add("isDraggable")}else e.onmousedown=null,u.classList.remove("isDraggable"),setIsCollapsed(u,!1)}}function handleAnchorClick(t,e,o){o.stopPropagation();o=getPopup(t);setIsDraggable(o,!getIsDraggable(o)),sendToAnchor(o,e)}function showPopup(t,e,o){o.stopPropagation();o=getPopup(t);sendToTop(o),setIsVisible(o,!0),getIsDraggable(o)||sendToAnchor(o,e)}function hidePopup(t,e){e.stopPropagation(),setIsVisible(getPopup(t),!1)}function setIsVisible(t,e){e?t.classList.add("visible"):t.classList.remove("visible")}function closePopup(t){setPopupScroll(t,0),setIsVisible(t,!1),setIsPinned(t,!1),setIsCollapsed(t,!1),setIsDraggable(t,!1)}function getButton(t,e){return t.getElementsByClassName(e)[0]}function setSaveButton(t,e){getButton(t,"popupHeaderButtonSave").innerHTML=e?"★":"☆"}function setPinButton(t,e){getButton(t,"popupHeaderButtonSticky").innerHTML=e?"●":"○"}Object.entries(PINNED_POPUP_DATA.getData()).forEach(([t,e])=>restorePopup(t,e));